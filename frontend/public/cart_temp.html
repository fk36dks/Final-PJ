<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>장바구니</title>
<style>
  :root{
    --bg:#faf9fb; --card:#fff; --border:#ece7f6; --ink:#111; --muted:#6b7280;
    --tint:#f1eaff; --pill:#f6f2ff; --accent:#6b47d6; --shadow:0 1px 10px rgba(0,0,0,.05);
    --container:1120px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif}
  .topbar{position:sticky;top:0;z-index:20;background:var(--bg);border-bottom:1px solid var(--border)}
  .topbar .bar{max-width:var(--container);margin:0 auto;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px}	
  .left,.right{display:flex;align-items:center;gap:12px}
  .brand{font-weight:800;font-size:20px;text-decoration:none;color:inherit;cursor:pointer}
  .pill{border:1px solid var(--border);background:var(--pill);height:30px;padding:0 10px;border-radius:999px;
        display:inline-flex;align-items:center;gap:6px;text-decoration:none;color:inherit;font-size:13px}

  .container{max-width:var(--container);margin:0 auto;padding:18px 16px}
  .page-head{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:14px}
  .nav-mini{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;
            border-radius:10px;height:32px;padding:0 10px;text-decoration:none;color:inherit}
  .page-title{font-size:22px;font-weight:800;margin:12px 0 24px}
  .empty{background:#fff;border:1px dashed var(--border);border-radius:16px;padding:24px;text-align:center;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:14px;margin-bottom:12px}
  .item{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:12px}
  .row{display:grid;grid-template-columns:110px 1fr 120px 24px;gap:12px;align-items:center}
  .thumb{width:110px;height:110px;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .name{font-weight:700}
  .muted{color:var(--muted);font-size:13px;margin-top:4px}
  .qty{display:inline-flex;align-items:center;border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-top:6px}
  .qty input{width:48px;border:0;text-align:center;height:32px;outline:none}
  .qty button{width:32px;height:32px;border:0;background:#f5f3ff;color:#5f4bc0;cursor:pointer}
  .price{text-align:right;font-weight:800}
  .remove{background:transparent;border:0;color:#888;font-size:18px;cursor:pointer}
  .checkout{margin-top:10px;width:100%;padding:14px;border-radius:12px;border:1px solid var(--border);background:var(--pill);color:var(--accent);font-weight:700;cursor:pointer}
  .total{display:flex;justify-content:flex-end;gap:12px;margin-top:6px;color:#333}

  /* ⬇ 로딩 오버레이 */
  .loading{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.85);z-index:9999}
  .loading.show{display:flex}
  .spinner{width:42px;height:42px;border-radius:50%;border:3px solid #d9cff7;border-top-color:#6b47d6;animation:rot 1s linear infinite}
  @keyframes rot{to{transform:rotate(360deg)}}
  .load-msg{margin-top:10px;color:#444;font-weight:700}
</style>
</head>
<body>
  <header class="topbar">
    <div class="bar">
      <div class="left">
        <a class="brand" href="index.html">Kolon</a>
      </div>
      <div class="right">
        <a class="pill" href="login.html">로그인</a>
        <a class="pill" href="signup.html">회원가입</a>
        <a class="pill" href="mypage.html">마이페이지</a>
        <a class="pill" href="points.html">포인트</a>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="page-head">
      <a class="nav-mini" href="search.html" id="prevBtn">← 이전</a>
    </div>
    <h1 class="page-title">내 장바구니</h1>

    <section id="cartList" class="list"></section>
    <div id="emptyBox" class="empty" style="display:none">장바구니가 비었습니다.</div>

    <div class="total"><div>합계:</div><div id="totalPrice">0원</div></div>
    <button class="checkout" id="checkoutBtn">구매하기</button>
    <div class="muted" id="pointHint" style="margin-top:8px"></div>
  </main>

  <!-- 로딩 오버레이 -->
  <div class="loading" id="loading" aria-hidden="true">
    <div style="display:flex;flex-direction:column;align-items:center">
      <div class="spinner" role="status" aria-label="로딩 중"></div>
      <div class="load-msg">결제 페이지로 이동 중...</div>
    </div>
  </div>

<script>
  const CART_KEY = 'cart';
  const POINT_KEY = 'points';
  const fmt = n => Number(n).toLocaleString('ko-KR') + '원';
  const getCart = () => { try{ return JSON.parse(localStorage.getItem(CART_KEY))||[] }catch(e){ return [] } };
  const setCart = (items) => { localStorage.setItem(CART_KEY, JSON.stringify(items)); };
  const getPoints = () => Number(localStorage.getItem(POINT_KEY) ?? 100000);

  async function render(){
    const listEl = document.getElementById('cartList');
    const emptyEl = document.getElementById('emptyBox');
    const totalEl = document.getElementById('totalPrice');
    const hintEl = document.getElementById('pointHint');
    const items = getCart();

    listEl.innerHTML = '';
    if(items.length===0){
      emptyEl.style.display = 'block';
      totalEl.textContent = '0원';
      hintEl.textContent = '';
      return;
    }
    emptyEl.style.display = 'none';

    let total = 0;
    items.forEach((it, idx)=>{
      total += it.price * it.qty;

      const row = document.createElement('article');
      row.className = 'item';
      row.innerHTML = `
        <div class="row">
          <div class="thumb"><img src="${it.image || it.img || it.thumbnail || it.thumb || ''}" alt="${it.name}"></div>
          <div>
            <div class="name">${it.name}</div>
            <div class="muted">${fmt(it.price)} / 개</div>
            <div class="qty">
              <button type="button" data-idx="${idx}" data-d="-1">−</button>
              <input type="text" value="${it.qty}" readonly>
              <button type="button" data-idx="${idx}" data-d="1">+</button>
            </div>
          </div>
          <div class="price">${fmt(it.price * it.qty)}</div>
          <button class="remove" title="삭제" data-rm="${idx}">×</button>
        </div>`;
      listEl.appendChild(row);
    });

    totalEl.textContent = fmt(total);
    
    // RDS에서 포인트 조회로 변경
    try {
      const response = await fetch('/api/demo/points');
      const data = await response.json();
      const rdsPoints = data.points_balance || 0;
      hintEl.textContent = '잔여 포인트: ' + Number(rdsPoints).toLocaleString('ko-KR') + 'P';
    } catch (error) {
      console.error('RDS 포인트 조회 실패:', error);
      // 실패 시 기존 로직 유지
      const p = getPoints();
      hintEl.textContent = '잔여 포인트: ' + Number(p).toLocaleString('ko-KR') + 'P';
    }
  }

  document.getElementById('cartList').addEventListener('click', (e)=>{
    const t = e.target;
    if(t.dataset.idx){
      const idx = Number(t.dataset.idx);
      const d = Number(t.dataset.d);
      const cart = getCart();
      cart[idx].qty = Math.max(1, (cart[idx].qty||1) + d);
      setCart(cart); render();
    }
    if(t.dataset.rm){
      const idx = Number(t.dataset.rm);
      const cart = getCart();
      cart.splice(idx,1); setCart(cart); render();
    }
  });

  // ✅ 자연스러운 로딩 후 결제 페이지로 이동 (RDS 포인트 확인)
  document.getElementById('checkoutBtn').addEventListener('click', async ()=>{
    const cart = getCart();
    const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
    
    if(total===0){ alert('장바구니가 비었습니다.'); return; }

    // RDS에서 실시간 포인트 확인
    let rdsPoints = 0;
    try {
      const response = await fetch('/api/demo/points');
      const data = await response.json();
      rdsPoints = data.points_balance || 0;
    } catch (error) {
      console.error('RDS 포인트 조회 실패:', error);
      // 실패 시 localStorage 포인트 사용
      rdsPoints = getPoints();
    }

    if(rdsPoints < total){
      alert(`포인트가 부족합니다.\n필요 포인트: ${total.toLocaleString()}원\n보유 포인트: ${rdsPoints.toLocaleString()}P\n\n포인트를 충전하거나 수량을 줄여주세요.`);
      return;
    }

    // 로딩 표시 & 버튼 비활성화
    const btn = document.getElementById('checkoutBtn');
    const loader = document.getElementById('loading');
    btn.disabled = true; btn.textContent = '결제 준비 중...';
    loader.classList.add('show');

    // 결제 페이지로 이동 (포인트 차감은 payment.html에서 처리)
    setTimeout(()=>{
      location.href = 'payment.html?amount=' + total;
    }, 800); // 로딩 연출 시간
  });

  render();
</script>
</body>
</html>
